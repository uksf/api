parameters:
  - name: environment
    type: string
  - name: serviceName
    type: string
  - name: deployPath
    type: string
  - name: variableGroup
    type: string
  - name: dependsOn
    type: string

jobs:
  - job: Deploy${{ parameters.environment }}
    displayName: Deploy to ${{ parameters.environment }}
    dependsOn: ${{ parameters.dependsOn }}
    variables:
      - group: ${{ parameters.variableGroup }}
    steps:
      - checkout: none

      - task: PowerShell@2
        displayName: 'Stop Service'
        inputs:
          targetType: 'inline'
          script: |
            $ErrorActionPreference = "Continue"
            $serviceName = "${{ parameters.serviceName }}"
            $nssm = "C:\Program Files\NSSM\win64\nssm.exe"
            $timeout = 60

            function Get-ServiceStatus {
                $output = & $nssm status $serviceName 2>&1 | Out-String
                return ($output -replace '[\r\n\s]+', ' ').Trim().ToUpper()
            }

            $status = Get-ServiceStatus
            Write-Host "Current service status: [$status]"

            if ($status -match "SERVICE_STOPPED") {
                Write-Host "Service is already stopped"
                exit 0
            }

            if ($status -match "NOT EXIST") {
                Write-Host "Service does not exist"
                exit 0
            }

            Write-Host "Stopping service: $serviceName"
            & $nssm stop $serviceName 2>&1 | Out-String | Write-Host

            $elapsed = 0
            $stopped = $false
            while ($elapsed -lt $timeout) {
                Start-Sleep -Seconds 2
                $elapsed += 2

                $status = Get-ServiceStatus
                Write-Host "Service status: [$status]"

                if ($status -match "SERVICE_STOPPED") {
                    Write-Host "Service stopped successfully"
                    $stopped = $true
                    break
                }
            }

            if (-not $stopped) {
                Write-Host "Service did not stop gracefully, forcing termination..."
                $process = Get-Process -Name "UKSF.Api" -ErrorAction SilentlyContinue
                if ($process) {
                    Write-Host "Killing process (PID: $($process.Id))"
                    Stop-Process -Id $process.Id -Force
                    Start-Sleep -Seconds 5
                }
            }

            Write-Host "Service stop complete"

      - task: CopyFiles@2
        displayName: 'Copy Files'
        inputs:
          SourceFolder: '$(buildOutput)'
          Contents: '**'
          TargetFolder: '${{ parameters.deployPath }}'
          CleanTargetFolder: true
          OverWrite: true

      - task: FileTransform@2
        displayName: 'Transform appsettings'
        inputs:
          folderPath: '${{ parameters.deployPath }}'
          xmlTransformationRules: ''
          jsonTargetFiles: 'appsettings.json'

      - task: PowerShell@2
        displayName: 'Start Service'
        inputs:
          targetType: 'inline'
          script: |
            $ErrorActionPreference = "Continue"
            $serviceName = "${{ parameters.serviceName }}"
            $nssm = "C:\Program Files\NSSM\win64\nssm.exe"
            $timeout = 30

            function Get-ServiceStatus {
                $output = & $nssm status $serviceName 2>&1 | Out-String
                return ($output -replace '[\r\n\s]+', ' ').Trim().ToUpper()
            }

            $status = Get-ServiceStatus
            Write-Host "Current service status: [$status]"

            if ($status -match "SERVICE_RUNNING") {
                Write-Host "Service is already running"
                exit 0
            }

            Write-Host "Starting service: $serviceName"
            & $nssm start $serviceName

            $elapsed = 0
            while ($elapsed -lt $timeout) {
                Start-Sleep -Seconds 2
                $elapsed += 2

                $status = Get-ServiceStatus
                Write-Host "Service status: [$status]"

                if ($status -match "SERVICE_RUNNING") {
                    Write-Host "Service started successfully"
                    exit 0
                }
            }

            Write-Error "Service failed to start within $timeout seconds"
            exit 1
