trigger:
  batch: true
  branches:
    include:
      - main

pool: Avengers

variables:
  buildConfiguration: 'Release'

jobs:
  - job: Build
    displayName: Build and Test
    steps:
      - task: DotNetCoreCLI@2
        displayName: 'Restore'
        inputs:
          command: 'restore'
          projects: '**/*.sln'
          feedsToUse: 'config'
          nugetConfigPath: 'NuGet.config'

      - task: DotNetCoreCLI@2
        displayName: 'Build'
        inputs:
          command: 'build'
          projects: '**/*.sln'
          arguments: '-c $(buildConfiguration) --no-restore'

      - task: DotNetCoreCLI@2
        displayName: 'Test'
        inputs:
          command: 'test'
          projects: '**/*.Tests*.csproj'
          arguments: '-c $(buildConfiguration) --no-build /p:CollectCoverage=true /p:CoverletOutputFormat=opencover'

      - task: DotNetCoreCLI@2
        displayName: 'Publish API'
        inputs:
          command: publish
          publishWebProjects: false
          projects: '**/UKSF.Api.csproj'
          arguments: '-c $(buildConfiguration) --output "$(Build.ArtifactStagingDirectory)/UKSF.Api"'
          zipAfterPublish: false
          modifyOutputPath: false

      - task: PublishPipelineArtifact@1
        displayName: 'Publish Artifact'
        inputs:
          targetPath: '$(Build.ArtifactStagingDirectory)/UKSF.Api'
          artifact: 'api'

  - job: DeployDev
    displayName: Deploy to Dev
    dependsOn: Build
    variables:
      - group: UKSF API - Dev
    steps:
      - download: current
        artifact: api

      - task: PowerShell@2
        displayName: 'Stop Service'
        inputs:
          targetType: 'inline'
          script: |
            $serviceName = "UKSF.Api.Dev"
            $timeout = 60

            Write-Host "Stopping service: $serviceName"
            $stopResult = & "C:\Program Files\NSSM\win64\nssm.exe" stop $serviceName 2>&1
            Write-Host "Stop command result: $stopResult"

            $elapsed = 0
            $stopped = $false
            while ($elapsed -lt $timeout) {
                $statusOutput = & "C:\Program Files\NSSM\win64\nssm.exe" status $serviceName 2>&1
                $statusText = ($statusOutput | Out-String).Trim()
                Write-Host "Service status: [$statusText]"

                if ($statusText -like "*SERVICE_STOPPED*" -or $statusText -like "*does not exist*") {
                    Write-Host "Service stopped successfully"
                    $stopped = $true
                    break
                }

                Start-Sleep -Seconds 2
                $elapsed += 2
            }

            if (-not $stopped) {
                Write-Host "Service did not stop gracefully, forcing termination..."
                $processName = "UKSF.Api"
                $process = Get-Process -Name $processName -ErrorAction SilentlyContinue
                if ($process) {
                    Write-Host "Killing process: $processName (PID: $($process.Id))"
                    Stop-Process -Id $process.Id -Force
                    Start-Sleep -Seconds 5
                }
            }

            Start-Sleep -Seconds 2
            Write-Host "Service stop complete"

      - task: CopyFiles@2
        displayName: 'Copy Files'
        inputs:
          SourceFolder: '$(Pipeline.Workspace)/api'
          Contents: '**'
          TargetFolder: 'C:\Server\UKSF.Api.Dev'
          CleanTargetFolder: true
          OverWrite: true

      - task: FileTransform@2
        displayName: 'Transform appsettings'
        inputs:
          folderPath: 'C:\Server\UKSF.Api.Dev'
          xmlTransformationRules: ''
          jsonTargetFiles: 'appsettings.json'

      - task: PowerShell@2
        displayName: 'Start Service'
        inputs:
          targetType: 'inline'
          script: |
            $serviceName = "UKSF.Api.Dev"

            Write-Host "Starting service: $serviceName"
            & "C:\Program Files\NSSM\win64\nssm.exe" start $serviceName

            Start-Sleep -Seconds 5
            $statusOutput = & "C:\Program Files\NSSM\win64\nssm.exe" status $serviceName 2>&1
            $statusText = ($statusOutput | Out-String).Trim()
            Write-Host "Service status: [$statusText]"

            if ($statusText -notlike "*SERVICE_RUNNING*") {
                Write-Error "Service failed to start"
                exit 1
            }

            Write-Host "Service started successfully"

  - job: DeployProd
    displayName: Deploy to Production
    dependsOn: DeployDev
    variables:
      - group: UKSF API - Production
    steps:
      - download: current
        artifact: api

      - task: PowerShell@2
        displayName: 'Stop Service'
        inputs:
          targetType: 'inline'
          script: |
            $serviceName = "UKSF.Api"
            $timeout = 60

            Write-Host "Stopping service: $serviceName"
            $stopResult = & "C:\Program Files\NSSM\win64\nssm.exe" stop $serviceName 2>&1
            Write-Host "Stop command result: $stopResult"

            $elapsed = 0
            $stopped = $false
            while ($elapsed -lt $timeout) {
                $statusOutput = & "C:\Program Files\NSSM\win64\nssm.exe" status $serviceName 2>&1
                $statusText = ($statusOutput | Out-String).Trim()
                Write-Host "Service status: [$statusText]"

                if ($statusText -like "*SERVICE_STOPPED*" -or $statusText -like "*does not exist*") {
                    Write-Host "Service stopped successfully"
                    $stopped = $true
                    break
                }

                Start-Sleep -Seconds 2
                $elapsed += 2
            }

            if (-not $stopped) {
                Write-Host "Service did not stop gracefully, forcing termination..."
                $processName = "UKSF.Api"
                $process = Get-Process -Name $processName -ErrorAction SilentlyContinue
                if ($process) {
                    Write-Host "Killing process: $processName (PID: $($process.Id))"
                    Stop-Process -Id $process.Id -Force
                    Start-Sleep -Seconds 5
                }
            }

            Start-Sleep -Seconds 2
            Write-Host "Service stop complete"

      - task: CopyFiles@2
        displayName: 'Copy Files'
        inputs:
          SourceFolder: '$(Pipeline.Workspace)/api'
          Contents: '**'
          TargetFolder: 'C:\Server\UKSF.Api'
          CleanTargetFolder: true
          OverWrite: true

      - task: FileTransform@2
        displayName: 'Transform appsettings'
        inputs:
          folderPath: 'C:\Server\UKSF.Api'
          xmlTransformationRules: ''
          jsonTargetFiles: 'appsettings.json'

      - task: PowerShell@2
        displayName: 'Start Service'
        inputs:
          targetType: 'inline'
          script: |
            $serviceName = "UKSF.Api"

            Write-Host "Starting service: $serviceName"
            & "C:\Program Files\NSSM\win64\nssm.exe" start $serviceName

            Start-Sleep -Seconds 5
            $statusOutput = & "C:\Program Files\NSSM\win64\nssm.exe" status $serviceName 2>&1
            $statusText = ($statusOutput | Out-String).Trim()
            Write-Host "Service status: [$statusText]"

            if ($statusText -notlike "*SERVICE_RUNNING*") {
                Write-Error "Service failed to start"
                exit 1
            }

            Write-Host "Service started successfully"

  - job: MigrateDB
    displayName: Migrate DB Data
    dependsOn: DeployProd
    steps:
      - checkout: none

      - task: PowerShell@2
        displayName: 'Migrate DB Data'
        inputs:
          targetType: 'inline'
          workingDirectory: 'C:\Program Files\MongoDB\Server\bin'
          script: |
            $password = "$(DbMigrationPassword)"

            Write-Host "Dumping prod database..."
            & .\mongodump --port=52005 --db prod --username admin --password $password --authenticationDatabase admin

            Write-Host "Restoring to dev database..."
            & .\mongorestore --port=52005 --db dev dump/prod --username admin --password $password --authenticationDatabase admin --drop --nsExclude dev.variables --nsExclude dev.gameServers --nsExclude dev.documentMetadata --nsExclude dev.scheduledJobs

            Write-Host "Dumping dev database..."
            & .\mongodump --port=52005 --db dev --username admin --password $password --authenticationDatabase admin

            Write-Host "Restoring to devLocal database..."
            & .\mongorestore --port=52005 --db devLocal dump/dev --username admin --password $password --authenticationDatabase admin --drop --nsExclude devLocal.variables --nsExclude devLocal.gameServers --nsExclude devLocal.documentMetadata --nsExclude devLocal.scheduledJobs

            Write-Host "DB migration complete"
