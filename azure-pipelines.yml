trigger:
  batch: true
  branches:
    include:
      - main

pool: Avengers

variables:
  buildConfiguration: 'Release'

jobs:
  - job: BuildAndDeploy
    displayName: Build and Deploy
    steps:
      - task: DotNetCoreCLI@2
        displayName: 'Restore'
        inputs:
          command: 'restore'
          projects: '**/*.sln'
          feedsToUse: 'config'
          nugetConfigPath: 'NuGet.config'

      - task: DotNetCoreCLI@2
        displayName: 'Build'
        inputs:
          command: 'build'
          projects: '**/*.sln'
          arguments: '-c $(buildConfiguration) --no-restore'

      - task: DotNetCoreCLI@2
        displayName: 'Test'
        inputs:
          command: 'test'
          projects: '**/*.Tests*.csproj'
          arguments: '-c $(buildConfiguration) --no-build /p:CollectCoverage=true /p:CoverletOutputFormat=opencover'

      - task: DotNetCoreCLI@2
        displayName: 'Publish API'
        inputs:
          command: publish
          publishWebProjects: false
          projects: '**/UKSF.Api.csproj'
          arguments: '-c $(buildConfiguration) --output "$(Build.BinariesDirectory)/UKSF.Api"'
          zipAfterPublish: false
          modifyOutputPath: false

      # Deploy to Dev
      - task: PowerShell@2
        displayName: 'Dev - Stop Service'
        inputs:
          targetType: 'inline'
          script: |
            $serviceName = "UKSF.Api.Dev"
            $timeout = 60

            Write-Host "Stopping service: $serviceName"
            $stopResult = & "C:\Program Files\NSSM\win64\nssm.exe" stop $serviceName 2>&1
            Write-Host "Stop command result: $stopResult"

            $elapsed = 0
            while ($elapsed -lt $timeout) {
                $status = & "C:\Program Files\NSSM\win64\nssm.exe" status $serviceName 2>&1
                Write-Host "Service status: $status"

                if ($status -match "SERVICE_STOPPED" -or $status -match "does not exist") {
                    Write-Host "Service stopped successfully"
                    break
                }

                Start-Sleep -Seconds 2
                $elapsed += 2
            }

            if ($elapsed -ge $timeout) {
                Write-Host "Service did not stop gracefully, forcing termination..."
                $processName = "UKSF.Api"
                $process = Get-Process -Name $processName -ErrorAction SilentlyContinue
                if ($process) {
                    Write-Host "Killing process: $processName (PID: $($process.Id))"
                    Stop-Process -Id $process.Id -Force
                    Start-Sleep -Seconds 5
                }
            }

            Start-Sleep -Seconds 2
            Write-Host "Service stop complete"

      - task: CopyFiles@2
        displayName: 'Dev - Copy Files'
        inputs:
          SourceFolder: '$(Build.BinariesDirectory)/UKSF.Api'
          Contents: '**'
          TargetFolder: 'C:\Server\UKSF.Api.Dev'
          CleanTargetFolder: true
          OverWrite: true

      - task: PowerShell@2
        displayName: 'Dev - Transform appsettings'
        inputs:
          targetType: 'inline'
          script: |
            $settingsPath = "C:\Server\UKSF.Api.Dev\appsettings.json"
            $settings = Get-Content $settingsPath | ConvertFrom-Json

            $settings.ConnectionStrings.Database = "$(Dev_ConnectionStrings_Database)"
            $settings.Kestrel.Endpoints.Https.Url = "$(Dev_Kestrel_Https_Url)"

            $settings | ConvertTo-Json -Depth 10 | Set-Content $settingsPath
            Write-Host "Dev appsettings.json updated"

      - task: PowerShell@2
        displayName: 'Dev - Start Service'
        inputs:
          targetType: 'inline'
          script: |
            $serviceName = "UKSF.Api.Dev"

            Write-Host "Starting service: $serviceName"
            & "C:\Program Files\NSSM\win64\nssm.exe" start $serviceName

            Start-Sleep -Seconds 5
            $status = & "C:\Program Files\NSSM\win64\nssm.exe" status $serviceName 2>&1
            Write-Host "Service status: $status"

            if ($status -notmatch "SERVICE_RUNNING") {
                Write-Error "Service failed to start"
                exit 1
            }

            Write-Host "Service started successfully"

      # Deploy to Production
      - task: PowerShell@2
        displayName: 'Prod - Stop Service'
        inputs:
          targetType: 'inline'
          script: |
            $serviceName = "UKSF.Api"
            $timeout = 60

            Write-Host "Stopping service: $serviceName"
            $stopResult = & "C:\Program Files\NSSM\win64\nssm.exe" stop $serviceName 2>&1
            Write-Host "Stop command result: $stopResult"

            $elapsed = 0
            while ($elapsed -lt $timeout) {
                $status = & "C:\Program Files\NSSM\win64\nssm.exe" status $serviceName 2>&1
                Write-Host "Service status: $status"

                if ($status -match "SERVICE_STOPPED" -or $status -match "does not exist") {
                    Write-Host "Service stopped successfully"
                    break
                }

                Start-Sleep -Seconds 2
                $elapsed += 2
            }

            if ($elapsed -ge $timeout) {
                Write-Host "Service did not stop gracefully, forcing termination..."
                $processName = "UKSF.Api"
                $process = Get-Process -Name $processName -ErrorAction SilentlyContinue
                if ($process) {
                    Write-Host "Killing process: $processName (PID: $($process.Id))"
                    Stop-Process -Id $process.Id -Force
                    Start-Sleep -Seconds 5
                }
            }

            Start-Sleep -Seconds 2
            Write-Host "Service stop complete"

      - task: CopyFiles@2
        displayName: 'Prod - Copy Files'
        inputs:
          SourceFolder: '$(Build.BinariesDirectory)/UKSF.Api'
          Contents: '**'
          TargetFolder: 'C:\Server\UKSF.Api'
          CleanTargetFolder: true
          OverWrite: true

      - task: PowerShell@2
        displayName: 'Prod - Transform appsettings'
        inputs:
          targetType: 'inline'
          script: |
            $settingsPath = "C:\Server\UKSF.Api\appsettings.json"
            $settings = Get-Content $settingsPath | ConvertFrom-Json

            $settings.ConnectionStrings.Database = "$(Prod_ConnectionStrings_Database)"
            $settings.Kestrel.Endpoints.Https.Url = "$(Prod_Kestrel_Https_Url)"

            $settings | ConvertTo-Json -Depth 10 | Set-Content $settingsPath
            Write-Host "Prod appsettings.json updated"

      - task: PowerShell@2
        displayName: 'Prod - Start Service'
        inputs:
          targetType: 'inline'
          script: |
            $serviceName = "UKSF.Api"

            Write-Host "Starting service: $serviceName"
            & "C:\Program Files\NSSM\win64\nssm.exe" start $serviceName

            Start-Sleep -Seconds 5
            $status = & "C:\Program Files\NSSM\win64\nssm.exe" status $serviceName 2>&1
            Write-Host "Service status: $status"

            if ($status -notmatch "SERVICE_RUNNING") {
                Write-Error "Service failed to start"
                exit 1
            }

            Write-Host "Service started successfully"

      # DB Migration
      - task: PowerShell@2
        displayName: 'Migrate DB Data'
        inputs:
          targetType: 'inline'
          workingDirectory: 'C:\Program Files\MongoDB\Server\bin'
          script: |
            $password = "$(DbMigrationPassword)"

            Write-Host "Dumping prod database..."
            & .\mongodump --port=52005 --db prod --username admin --password $password --authenticationDatabase admin

            Write-Host "Restoring to dev database..."
            & .\mongorestore --port=52005 --db dev dump/prod --username admin --password $password --authenticationDatabase admin --drop --nsExclude dev.variables --nsExclude dev.gameServers --nsExclude dev.documentMetadata --nsExclude dev.scheduledJobs

            Write-Host "Dumping dev database..."
            & .\mongodump --port=52005 --db dev --username admin --password $password --authenticationDatabase admin

            Write-Host "Restoring to devLocal database..."
            & .\mongorestore --port=52005 --db devLocal dump/dev --username admin --password $password --authenticationDatabase admin --drop --nsExclude devLocal.variables --nsExclude devLocal.gameServers --nsExclude devLocal.documentMetadata --nsExclude devLocal.scheduledJobs

            Write-Host "DB migration complete"
